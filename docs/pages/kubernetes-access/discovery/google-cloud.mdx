---
title: Teleport GKE Auto-Discovery (Preview)
description: How to configure auto-discovery of Google Kubernetes Engine clusters in Teleport.
---

The Teleport Discovery Service can automatically register your Google Kubernetes
Engine (GKE) clusters with Teleport. With Teleport Kubernetes Auto-Discovery,
you can configure the Teleport Kubernetes Service and Discovery Service once,
then create GKE clusters without needing to register them with Teleport after
each creation.  

In this guide, we will show you how to get started with Teleport Kubernetes
Auto-Discovery for GKE.

## Overview

(!docs/pages/kubernetes-access/discovery/includes/step-description.mdx!)

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- A Google Cloud account with permissions to create GKE clusters, IAM roles, and
  service accounts.
- One or more GKE clusters running. Your Kubernetes user must have permissions
  to create `ClusterRole` and `ClusterRoleBinding` resources in your clusters.
- A Linux host where you will run the Teleport Discovery and Kubernetes
  services. You can run this host on any cloud provider or even use a local
  machine.

(!docs/pages/includes/tctl.mdx!)

## Step 1/3. Obtain Google Cloud credentials

The Teleport Discovery Service uses a Google Cloud service account to
authenticate to your Google Cloud account and discover GKE clusters. In this
step, you will create a service account and download a credentials file for the
Teleport Discovery Service.

### Create an IAM role

The Teleport Discovery Service needs permissions to access GKE clusters
associated with your Google Cloud project. To grant it these permissions, create
a new IAM role.

Visit the [IAM & Admin](https://console.cloud.google.com/iam-admin/roles) page
of the Google Cloud console. Click **Create Role**.

For **Title**, enter `GKE Cluster Discoverer`.

For **ID**, enter `GKEKubernetesAutoDisc`.

Set **Role launch stage** to "General Availability".

Click **Add Permissions** and ensure that you include the following:

- `container.clusters.get`
- `container.clusters.list`

Click **Create**.

### Create a service account

In the Google Cloud console, go to the [Service
Accounts](https://console.cloud.google.com/iam-admin/serviceaccounts) page,
select the project associated with your GKE cluster, and click **Create Service
Account**.

For **Service account name**, enter "Teleport Discovery Service". The Google
Cloud console will suggest an ID similar to `teleport-discovery-service`. We
will assume that you are using this service account ID for the rest of this
guide.

Click **Create and Continue**.

In the **Grant this service account access to project** section, select the `GKE
Cluster Discoverer` role you created earlier, then click **Continue**, then
**Done**.

### Download a credentials file

Once you create your service account, find the service account you crated in the
[Service accounts](https://console.cloud.google.com/iam-admin/serviceaccounts)
page of the Google Cloud console and click the link. Click the **Keys** tab,
then **Add Key** > **Create new key**. Select the **JSON** radio button, then
**Create**. 

Move your credentials file to the host running the Teleport Discovery Service at
the path `/var/lib/teleport/google-cloud-credentials.json`. We will use this
credentials file when running these services later in this guide.

## Step 2/3. Authorize the Teleport Kubernetes Service to manage access

To forward requests to the Kubernetes cluster, the Teleport Kubernetes Service 
requires cluster-wide permissions to impersonate RBAC users and groups, to
create `SelfSubjectAccessReviews` and `SelfSubjectRulesReviews`, and, finally,
to view pods in the cluster.

To enable this access, define a manifest with the following content in a file
called `teleport-auth.yaml`:


```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: teleport
rules:
- apiGroups:
  - ""
  resources:
  - users
  - groups
  - serviceaccounts
  verbs:
  - impersonate
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
- apiGroups:
  - "authorization.k8s.io"
  resources:
  - selfsubjectaccessreviews
  - selfsubjectrulesreviews
  verbs:
  - create
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: teleport
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: teleport
subjects:
- kind: Group
  name: teleport
  apiGroup: rbac.authorization.k8s.io
```

Ensure that you are in the correct context for your GKE cluster, since running
`tsh login` will update your context to one named after your Teleport cluster:

```code
$ kubectl config current-context
wrong-context-name
$ kubectl config get-contexts
wrong-context-name
context-1
context-2
my-gke-cluster
$ kubectl config use-context mygke-cluster
```

Create the following resources using `kubectl`:

```code
$ kubectl create -f teleport-auth.yaml
clusterrole.rbac.authorization.k8s.io/teleport created
clusterrolebinding.rbac.authorization.k8s.io/teleport created
```

## Step 3/3. Configure Teleport to discover GKE clusters

Now that you have created a service account that can discover GKE clusters and a
cluster role that can manage access, configure the Teleport Discovery Service to
detect GKE clusters and the Kubernetes Service to proxy user traffic.

### Install Teleport

Install Teleport on the host you are using to run the Kubernetes Service and
Discovery Service:

(!docs/pages/includes/install-linux.mdx!)

### Create a join token 

The Teleport Discovery Service and Kubernetes Service require an authentication
token in order to to join the cluster. Generate one by running the following
command: 

```code
$ tctl tokens add --type=discovery,kube
The invite token: (=presets.tokens.first=)
This token will expire in 60 minutes.

Run this on the new node to join the cluster:

> teleport start \
   --roles=discovery,kube \
   --token=(=presets.tokens.first=) \
   --ca-pin=(=presets.ca_pin=) \
   --auth-server=192.0.2.255:3025

Please note:

  - This invitation token will expire in 60 minutes
  - 192.0.2.255:3025 must be reachable from the new node
```

Copy the token (e.g., `(=presets.tokens.first=)` above) and save the token in
`/tmp/token` on the machine that will run the Discovery Service and Kubernetes
Service, for example:

```code
$ echo (=presets.tokens.first=) | sudo tee /tmp/token
```

### Configure the Kubernetes Service and Discovery Service

On the host running the Kubernetes Service and Discovery Service, create a
Teleport configuration file with the following content at `/etc/teleport.yaml`:

```yaml
version: v2
teleport:
  join_params:
    token_name: "/tmp/token"
    method: token
  auth_servers:
  - "teleport.example.com:3080"
auth_service:
  enabled: off
proxy_service:
  enabled: off
ssh_service:
  enabled: off
discovery_service:
  enabled: "yes"
  gcp:
    - types: ["gke"]
      locations: ["*"]
      project_ids: ["myproject"] # replace with my project ID
      tags: ["*"]
kubernetes_service:
  enabled: "yes"
  resources:
  - labels:
      "*": "*"
```

Edit this configuration for your environment. Replace
`teleport.example.com:3080` with the host and port of your Teleport Proxy
Service (e.g., `mytenant.teleport.sh:443` for a Teleport Cloud tenant).

Each item in `discovery_service.gcp` is a **matcher** for Kubernetes clusters
in GKE. The Discovery Service periodically executes a request to the Google
Cloud API based on each matcher to list GKE clusters. In this case, we will
declare a single matcher.

Each matcher's `types` field must be set to an array with a single string
value, `gke`. 

In your matcher, replace `myproject` with the ID of your Google Cloud project.
The `project_ids` field must include at least one value, and it must not be the
wildcard character (`*`).

Each matcher's `locations` field contains an array of Google Cloud region or
zone names that the matcher will search for GKE clusters. The wildcard
character, `*`, configures the matcher to search all locations.  

Like `locations`, `tags` consists of an array of strings. A wildcard value
matches all tags in your Google Cloud account. If you include another value,
the matcher will match all GKE clusters with the provided tag. 

Each matcher searches for clusters that match _all_ properties of the matcher,
i.e., that belong to the specified locations and projects and have the
specified tags. The Discovery Service registers GKE clusters that match _any_
configured matcher.

### Start the Kubernetes Service and Discovery Service 

On the host where you will run the Kubernetes Service, execute the following
command, depending on whether you installed Teleport using a package manager or
via a TAR archive:

<Tabs>
<TabItem label="Package Manager">

When you installed Teleport via package manager, the installation process
created a configuration for the init system `systemd` to run Teleport as a
daemon. 

This service reads environment variables from a file at the path
`/etc/default/teleport`. Teleport's built-in Google Cloud client reads the
credentials file at the location given by the `GOOGLE_APPLICATION_CREDENTIALS`
variable. 

Run the following command to enable Teleport to read the credentials file: 

```code
$ cat<<EOF | sudo tee /etc/default/teleport
GOOGLE_APPLICATION_CREDENTIALS="/var/lib/teleport/google-cloud-credentials.json"
EOF

```
{/*TODO: the empty line prevents "undefined" from rendering*/}

Start the Teleport service:

```code
$ sudo systemctl start teleport
```
</TabItem>
<TabItem label="TAR Archive">

To authenticate to Google Cloud, Teleport's built-in Google Cloud client reads
the credentials file at the location given by the
`GOOGLE_APPLICATION_CREDENTIALS` variable. Run Teleport with this variable
assigned:

```code
$ export GOOGLE_APPLICATION_CREDENTIALS="/var/lib/teleport/google-cloud-credentials.json"
$ sudo -E teleport start
```
</TabItem>
</Tabs>

## Step 4/4. Connect to your GKE cluster

### Allow access to your Kubernetes cluster

Ensure that you are in the correct Kubernetes context for the cluster you would
like to enable access to.

Retrieve all available contexts:

```code
$ kubectl config get-contexts
```

Switch to your context, replacing `CONTEXT_NAME` with the name of your chosen
context:

```code
$ kubectl config use-context CONTEXT_NAME
Switched to context CONTEXT_NAME
```

(!docs/pages/includes/kubernetes-access/rbac.mdx!)

### Access your cluster

Run the following command to list the Kubernetes clusters that your Teleport
userh as access to. The list should now include your GKE cluster:

```code
$ tsh kube ls
```

Log in to your cluster, replacing `mycluster` with the name of a cluster you
listed previously:

```code
$ tsh kube login mycluster
```

## Troubleshooting

(!docs/pages/kubernetes-access/discovery/includes/troubleshooting.mdx!)
